<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.61" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://vongdefu.github.io/05-distribution/distribution/transaction.html"><meta property="og:site_name" content="cs-tips"><meta property="og:title" content="分布式事务"><meta property="og:description" content="[ ] 需要按照提纲再次整理; 提纲 1. 本地事务、全局事务、分布式事务； 2. 事务特性 3. 出现分布式事务的业务架构； 4. CAP 和 BASE 理论 5. 为什么分布式事务难？【从技术架构上讲、团队学习成本、性能上（包括吞吐量和运行时间上、给数据库本身造成的影响上）、系统复杂性和可用性上取舍】 6. 分布式事务理论及实践（2PC、3PC、S..."><meta property="og:type" content="article"><meta property="og:image" content="https://vongdefu.github.io/"><meta property="og:locale" content="zh-CN"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image:alt" content="分布式事务"><meta property="article:author" content="vongdefu"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"分布式事务","image":["https://vongdefu.github.io/"],"dateModified":null,"author":[{"@type":"Person","name":"vongdefu","url":"https://github.com/vongdefu"}]}</script><link rel="icon" href="/favicon.ico"><link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#46bd87"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"><title>分布式事务 | cs-tips</title><meta name="description" content="[ ] 需要按照提纲再次整理; 提纲 1. 本地事务、全局事务、分布式事务； 2. 事务特性 3. 出现分布式事务的业务架构； 4. CAP 和 BASE 理论 5. 为什么分布式事务难？【从技术架构上讲、团队学习成本、性能上（包括吞吐量和运行时间上、给数据库本身造成的影响上）、系统复杂性和可用性上取舍】 6. 分布式事务理论及实践（2PC、3PC、S...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-8909e15b.css" as="style"><link rel="stylesheet" href="/assets/style-8909e15b.css">
    <link rel="modulepreload" href="/assets/app-fb6938a2.js"><link rel="modulepreload" href="/assets/framework-16b96b76.js"><link rel="modulepreload" href="/assets/transaction.html-7427a94d.js"><link rel="modulepreload" href="/assets/transaction.html-7995f06f.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-start"><button type="button" class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><img class="logo" src="/logo.svg" alt="cs-tips"><!----><span class="site-name hide-in-pad">cs-tips</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/" class="nav-link" aria-label="主页"><span class="font-icon icon iconfont icon-home" style=""></span>主页<!----></a></div><div class="nav-item hide-in-mobile"><a href="/01-csbase" class="nav-link" aria-label="要点提示"><span class="font-icon icon iconfont icon-ability" style=""></span>要点提示<!----></a></div><div class="nav-item hide-in-mobile"><a href="https://github.com/vongdefu/vongdefu.github.io/issues" rel="noopener noreferrer" target="_blank" aria-label="问题反馈" class="nav-link"><span class="font-icon icon iconfont icon-note" style=""></span>问题反馈<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-end"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/vongdefu/vongdefu.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><!----><!--[--><button type="button" class="search-pro-button" role="search" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="placeholder">搜索</div><div class="key-hints"><kbd class="key">Ctrl</kbd><kbd class="key">K</kbd></div></button><!--]--><!--[--><!----><!--]--><button type="button" class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><!----><span class="title">面渣</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-computer" style=""></span><span class="title">01-CS基础</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-java" style=""></span><span class="title">02-Java编程语言</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-layout" style=""></span><span class="title">03-框架</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-api" style=""></span><span class="title">04-中间件</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active" type="button"><span class="font-icon icon iconfont icon-structure" style=""></span><span class="title">05-分布式</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/05-distribution/api.html" class="nav-link sidebar-link sidebar-page" aria-label="API（接口）"><!---->API（接口）<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active" type="button"><!----><a href="/05-distribution/distribution/" class="title">分布式系统</a><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/05-distribution/distribution/cache.html" class="nav-link sidebar-link sidebar-page" aria-label="分布式缓存"><!---->分布式缓存<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/05-distribution/distribution/duration.html" class="nav-link sidebar-link sidebar-page" aria-label="分布式存储"><!---->分布式存储<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/05-distribution/distribution/id.html" class="nav-link sidebar-link sidebar-page" aria-label="分布式ID"><!---->分布式ID<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/05-distribution/distribution/job.html" class="nav-link sidebar-link sidebar-page" aria-label="分布式任务"><!---->分布式任务<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/05-distribution/distribution/lock.html" class="nav-link sidebar-link sidebar-page" aria-label="分布式锁"><!---->分布式锁<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/05-distribution/distribution/message.html" class="nav-link sidebar-link sidebar-page" aria-label="分布式消息"><!---->分布式消息<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/05-distribution/distribution/session.html" class="nav-link sidebar-link sidebar-page" aria-label="分布式会话"><!---->分布式会话<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/05-distribution/distribution/theory.html" class="nav-link sidebar-link sidebar-page" aria-label="基础理论"><!---->基础理论<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/05-distribution/distribution/transaction.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="分布式事务"><!---->分布式事务<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/05-distribution/distribution/transaction.html#_1-分布式事务" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1. 分布式事务"><!---->1. 分布式事务<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/05-distribution/distribution/transaction.html#_1-1-背景" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.1. 背景"><!---->1.1. 背景<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/05-distribution/distribution/transaction.html#_1-2-xa理论" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.2. XA理论"><!---->1.2. XA理论<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/05-distribution/distribution/transaction.html#_1-3-2pc" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.3. 2PC"><!---->1.3. 2PC<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/05-distribution/distribution/transaction.html#_1-4-sagas方案" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.4. SAGAS方案"><!---->1.4. SAGAS方案<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/05-distribution/distribution/transaction.html#_1-5-3pc" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.5. 3PC"><!---->1.5. 3PC<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/05-distribution/distribution/transaction.html#_1-6-tcc" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.6. TCC"><!---->1.6. TCC<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/05-distribution/distribution/transaction.html#_1-7-本地消息表方案" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.7. 本地消息表方案"><!---->1.7. 本地消息表方案<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/05-distribution/distribution/transaction.html#_1-8-最大努力通知方案" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.8. 最大努力通知方案"><!---->1.8. 最大努力通知方案<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/05-distribution/distribution/transaction.html#_1-9-可靠消息最终一致性方案" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.9. 可靠消息最终一致性方案"><!---->1.9. 可靠消息最终一致性方案<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/05-distribution/distribution/transaction.html#_1-10-总结" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.10. 总结"><!---->1.10. 总结<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/05-distribution/distribution/transaction.html#_1-11-附言" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.11. 附言"><!---->1.11. 附言<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/05-distribution/distribution/transaction.html#_2-seata的at、tcc、saga和xa事务模式" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2. Seata的AT、TCC、SAGA和XA事务模式"><!---->2. Seata的AT、TCC、SAGA和XA事务模式<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li></ul></section></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-like" style=""></span><span class="title">06-软件质量管理</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-editor" style=""></span><span class="title">07-工程设计</span><span class="arrow end"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->分布式事务</h1><!----><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/05-distribution/distribution/transaction.html#_1-分布式事务" class="router-link-active router-link-exact-active toc-link level3">1. 分布式事务</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/05-distribution/distribution/transaction.html#_1-1-背景" class="router-link-active router-link-exact-active toc-link level4">1.1. 背景</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/05-distribution/distribution/transaction.html#_1-2-xa理论" class="router-link-active router-link-exact-active toc-link level4">1.2. XA理论</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/05-distribution/distribution/transaction.html#_1-3-2pc" class="router-link-active router-link-exact-active toc-link level4">1.3. 2PC</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/05-distribution/distribution/transaction.html#_1-4-sagas方案" class="router-link-active router-link-exact-active toc-link level4">1.4. SAGAS方案</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/05-distribution/distribution/transaction.html#_1-5-3pc" class="router-link-active router-link-exact-active toc-link level4">1.5. 3PC</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/05-distribution/distribution/transaction.html#_1-6-tcc" class="router-link-active router-link-exact-active toc-link level4">1.6. TCC</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/05-distribution/distribution/transaction.html#_1-7-本地消息表方案" class="router-link-active router-link-exact-active toc-link level4">1.7. 本地消息表方案</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/05-distribution/distribution/transaction.html#_1-8-最大努力通知方案" class="router-link-active router-link-exact-active toc-link level4">1.8. 最大努力通知方案</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/05-distribution/distribution/transaction.html#_1-9-可靠消息最终一致性方案" class="router-link-active router-link-exact-active toc-link level4">1.9. 可靠消息最终一致性方案</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/05-distribution/distribution/transaction.html#_1-10-总结" class="router-link-active router-link-exact-active toc-link level4">1.10. 总结</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/05-distribution/distribution/transaction.html#_1-11-附言" class="router-link-active router-link-exact-active toc-link level4">1.11. 附言</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/05-distribution/distribution/transaction.html#_2-seata的at、tcc、saga和xa事务模式" class="router-link-active router-link-exact-active toc-link level3">2. Seata的AT、TCC、SAGA和XA事务模式</a></li><!----><!--]--></ul></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><ul class="task-list-container"><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-0" disabled="disabled"><label class="task-list-item-label" for="task-item-0"> 需要按照提纲再次整理</label></li></ul><blockquote><p>提纲</p><ol><li>本地事务、全局事务、分布式事务；</li><li>事务特性</li><li>出现分布式事务的业务架构；</li><li>CAP 和 BASE 理论</li><li>为什么分布式事务难？【从技术架构上讲、团队学习成本、性能上（包括吞吐量和运行时间上、给数据库本身造成的影响上）、系统复杂性和可用性上取舍】</li><li>分布式事务理论及实践（2PC、3PC、Seaga、XA、本地事务消息、TCC、AT）</li></ol></blockquote><h3 id="_1-分布式事务" tabindex="-1"><a class="header-anchor" href="#_1-分布式事务" aria-hidden="true">#</a> 1. 分布式事务</h3><p>本文主要从以下几个方面来讲述分布式事务的相关内容：</p><ol><li>分布式事务的背景</li><li>七种分布式方案（<code>XA规范</code>、<code>2PC理论</code>、<code>SAGAS方案</code>、<code>3PC</code>、<code>TCC方案（异步确保型、补偿型）</code>、<code>本地消息表方案</code>、<code>最大努力通知方案</code>、<code>可靠消息最终一致性方案</code>）的原理、优缺点、所出现的问题、适用的场景、技术的细节</li><li>分布式事务Seata的使用</li></ol><p>学习的主要方法是<code>带着问题去学习</code>，具体步骤如下：</p><ol><li>先了解分布式事务出现的背景，要知道一种新的技术或者新的理论的出现，一定是为了解决某个问题而产生的，不可能平白无故产生；</li><li>了解人们在解决分布式事务这个问题的过程中都提出了哪些解决方案，每个解决方案的具体原理是怎样的，这每一个解决方案是否又引入了新的问题，这些新的问题是什么，为了解决这些引入的新的问题，人们又提出了哪些解决方案；</li><li>在实际的生产环境下如何实践分布式事务，不同方案之间的适用场景有哪些；</li></ol><h4 id="_1-1-背景" tabindex="-1"><a class="header-anchor" href="#_1-1-背景" aria-hidden="true">#</a> 1.1. 背景</h4><p>我们先来解释三个名词：</p><ul><li><strong>数据库事务</strong>： 是从数据库层面来解决事务的，它是由实现数据库的具体技术来保证的，比如MySQL的innodb引擎中的事务实现；</li><li><strong>本地事务</strong>： 是由应用程序来保证的。比如一个应用场景中要往A表中插入一条数据，然后再从B表中删除一条数据，此时插入和删除是两条SQL，并且这两条数据都是由应用程序分别发起的，因此要跟数据库交互至少两次，这就没有办法使用数据库事务机制来保证事务了，因此就需要由应用程序来保证事务，于是在Spring中我们可以使用事务注解的形式来保证事务；</li><li><strong>分布式事务</strong>： 则是由更高一层次的事务框架协议来保证；</li></ul><p>为什么会出现分布式事务？分布式事务是出现在分布式系统中的。</p><p>假设有一个业务场景，如<code>流量充值业务</code>，我们系统中有这么几个模块：转账模块、流量管理模块、积分模块，主要的业务场景是：转账成功后，需要修改用户的流量，并修改用户的积分。那在这个流量充值业务中，我们就需要做到这几个操作全部成功，如果遇到异常也要全部失败，不能出现转账成功了，但是流量没有充值成功，也不能出现流量充值成功了，但是积分没有成功，也就是说<strong>要保证这三个操作，要么全部成功，要么全部失败</strong>。那么，这样一个针对不同的数据源的组合操作，就是分布式事务。</p><p>本质上，分布式事务有一个特点： <strong>跨应用程序执行事务操作</strong>。</p><h4 id="_1-2-xa理论" tabindex="-1"><a class="header-anchor" href="#_1-2-xa理论" aria-hidden="true">#</a> 1.2. XA理论</h4><p>起先X/Open组织提出了<strong>一种XA规范，就是一套务虚的理论</strong>。在这个理论中定义了几个角色，</p><ul><li>AP，就是我们的应用；</li><li>TM，就是事务管理器；</li><li>RM，就是资源管理器；</li><li>CRM，就是通信资源管理器，可以理解为消息中间件，但是可以没有。</li></ul><p>其原理基本就是：</p><ol><li>AP告诉TM，说我要发起一个全局事务了；</li><li>然后TM就会往RM中分别发送一条消息，然后RM就进行事务的提交或回滚；</li></ol><p>说白了就是TM定义了一套跟RM进行通信和交互的接口规范，然后通过接口来通知RM，来一块做一下提交或回滚。</p><p>XA理论只是一种务虚的理论，意思就是它提出了一个实现分布式的一个标准而已。</p><h4 id="_1-3-2pc" tabindex="-1"><a class="header-anchor" href="#_1-3-2pc" aria-hidden="true">#</a> 1.3. 2PC</h4><p><strong>2PC理论，就是基于XA规范做的一种具体的实践</strong>，说白了就是两阶段提交，先有一个准备阶段，然后告诉所有的RM，先准备一下，要开始做事务了；然后TM收到消息后开始发起提交阶段的请求，告诉所有的RM，开始提交。但是如果TM在发送准备阶段的提交请求时，收到了某一个RM的异常响应，那么整个事务就立马失败了；如果在提交阶段也收到了RM的异常响应，也会立马失败，然后回滚已经执行的事务。准备阶段实际上是利用了commit和rollback机制，即TM直接发送给所有的RM，让RM执行操作，这个时候可以认为数据库中是已经有数据变更的；在提交阶段，TM根据收到的上一阶段的消息汇总后得出是否允许提交的结论，再去告诉所有的RM执行commit或rollback操作。</p><p>2PC是有问题的，在准备阶段RM收到消息后，会对资源进行锁定，如果下一次收到提交的消息中间有很长时间，这就造成了数据库系统的<code>并发量下降</code>；此外还会出现<code>单点故障</code>的问题，TM是一个单点，如果出现单点故障问题，就完了；此外也会出现<code>状态丢失</code>的情况，如对TM做了备份，在主TM宕机后，重新选举从TM时，之前TM发送的状态，新的TM是不知道的；还会<code>发生脑裂</code>的问题，如果在TM切换过程中，有些RM收到了提交消息，有些没有收到提交消息，这也是不行的。基于这些问题的考量，又引入了3PC理论。</p><p>2PC比较适合单体应用中跨多个库的分布式事务，而且这种方式是严重依赖数据库层面来搞定分布式事务的，并发度很低。但微服务中，我们是不允许微服务交叉访问数据库的，我们一般要求必须通过调用对应的服务来操作服务底层的数据库。</p><h4 id="_1-4-sagas方案" tabindex="-1"><a class="header-anchor" href="#_1-4-sagas方案" aria-hidden="true">#</a> 1.4. SAGAS方案</h4><p>由于2PC阶段中，最后TM通知每一个RM进行提交事务时，如果涉及到很多的操作，那么这个TM的执行操作会很长，因此基于这个问题的解决，又提出了SAGAS方案，其核心思想就是把长事务拆分成短事务。</p><p>这种方案并发度较高，但是需要定义补偿操作，开发量较大，此外次方案一致性较弱，可能会出现一个事务执行成功，另外一个事务执行失败的问题。</p><h4 id="_1-5-3pc" tabindex="-1"><a class="header-anchor" href="#_1-5-3pc" aria-hidden="true">#</a> 1.5. 3PC</h4><p>三阶段提交方案：</p><ul><li>一阶段：TM给RM发送cancommit消息，根据响应消息判断各RM是否正常；</li><li>二阶段：TM给RM发送precommit消息，告知各RM准备相关的sql及请求链接等；</li><li>三阶段：TM给RM发送docommit消息，通知各RM进行提交；</li></ul><p>这个方案解决了2PC方案中的TM异常时会导致整个事务不成功的问题，同时也不会锁定资源很久导致并发度下降的问题。此外，如果TM在第三阶段中发生了异常，事务也是有可能成功的，因为RM会在收到precommit消息后，一段时间后如果TM宕机，RM也会自动提交，因为收到的precommit的消息的响应是正常的。</p><p>但是这种方案也还是有问题的，如果发生脑裂问题进行TM的切换过程中，RM根据超时机制判定TM不可用，自己提交了事务，但是事实上TM切换后是要发送cancel消息的，因此这也是一种问题。</p><h4 id="_1-6-tcc" tabindex="-1"><a class="header-anchor" href="#_1-6-tcc" aria-hidden="true">#</a> 1.6. TCC</h4><p>就是try-confirm-cancel事务机制，在try阶段对转账金额进行锁定，confirm阶段先往本地数据库中插入要锁定的金额的记录，然后调用b银行的扣减金额的接口，再调用c银行的增加金额的接口；cancel阶段就先把c的金额给减掉，然后把b的金额再加回去。通俗一点讲就是try阶段准备各服务所需要的资源或对某些资源进行锁定，confirm就是进行各服务的提交，cancel阶段就是进行补偿，把原来成功的事务进行回滚。</p><p>TCC就是针对要求数据强一致性时才会使用到这种方案，因为这种方案要求写额外的补偿事务的代码，这不利于代码的维护。一般情况下，只有在要求转账这些涉及到钱的一些业务操作时才会使用这种方案，否则，不会采用这种方案的，因为补偿的业务代码非常复杂，也不利于系统的维护。</p><h4 id="_1-7-本地消息表方案" tabindex="-1"><a class="header-anchor" href="#_1-7-本地消息表方案" aria-hidden="true">#</a> 1.7. 本地消息表方案</h4><p>本地消息表方案是国外ebay搞的一套方案，其原理大概是这样的： 1.服务a先往自己本地表中插入一条消息数据，然后执行业务操作，再往mq中发送事务消息； 2.服务b接收到消息后，先去查一下本地消息表中是否有改消息id，如果有就丢弃，如果没有就往自己本地表中插入一条消息数据，然后执行业务操作，完成后更新消息数据，再调用a接口更新a的消息数据状态；</p><figure><img src="/assets/1699929311125-e7b887db.png" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><p>假设b没有接收到数据，a也会有一个定时任务，去查自己本地消息表中未处理过的消息数据，然后再发送给mq中让b去处理，重复这个过程直到b调用a的接口完成了a的消息状态的更新。</p><p>但是这种方案严重依赖本地消息表，如果碰到高并发的场景，那应该怎么处理呢？这种场景下肯定是不行的。</p><h4 id="_1-8-最大努力通知方案" tabindex="-1"><a class="header-anchor" href="#_1-8-最大努力通知方案" aria-hidden="true">#</a> 1.8. 最大努力通知方案</h4><p>这种方案是基于本地消息表方案的一种延伸，把写本地消息表的过程也通过mq或内存队列的方式进行削峰，它中间多了一个尽最大努力通知的服务。基本过程是：a服务执行完业务操作后，往mq中发送一条消息，尽最大努力通知服务接收到这条消息后，往本地消息表中添加一条数据，然后调用b服务接口以求完成业务操作，b完成业务操作之后调用尽最大努力通知服务的接口修改本地消息记录的状态。此外，尽最大努力通知服务也会有一个定时任务，会定时查询本地消息表中的消息状态，如果查到未结束的消息，就接着调用b服务接口以完成业务操作，重复n次后就结束。</p><p>这种方式通过引入尽最大努力通知的服务来避免了本地消息表高并发场景下流量高峰的情况，让这个服务单独处理本地事务消息，并通过定时任务的方式尽最大努力通知到另外的服务进行业务动作。</p><h4 id="_1-9-可靠消息最终一致性方案" tabindex="-1"><a class="header-anchor" href="#_1-9-可靠消息最终一致性方案" aria-hidden="true">#</a> 1.9. 可靠消息最终一致性方案</h4><p>这种方式直接把弃用本地消息表，直接使用mq组件的消息事务机制。其基本原理大概是： 1.a服务先发一个prepare消息给mq，如果失败，就直接放弃操作； 2.如果成功，a服务就会进行业务操作，操作完成后，如果操作状态为成功，往mq中发送confirm消息；如果操作状态为失败，就回滚mq中的消息； 3.此时b服务收到mq的confirm消息，然后执行本地业务操作；</p><p>这个过程中有几个问题： 1.如果a服务发了prepare消息给mq，但是没有发送confirm消息，那么mq会轮训prepare消息，然后回调a服务的接口，询问a的业务操作是否成功，a再去查自己的表看业务操作是否成功，如果成功mq自动生成confirm消息，如果失败就回滚消息； 2.如果b服务对同一个confirm消息接收到了多次，那么此时b服务就需要做接口幂等性保证，可以每次执行一个confirm消息就创建一个zk的node节点，消费同一个消息，创建node节点会失败；也可以在每消费一个confirm消息就在redis中添加一个key，每次消费前先去查一下这个key是否存在这两种方案来保证接口幂等性； 3.如果b服务接收到confirm消息后执行失败了，那应该怎么办呢，这需要b服务一直重试，直到成功；或者是通知a进行回滚，再或者是事后通过报警信息、日志信息等进行手动业务补偿。</p><p>这种方式是国内通用的处理方案。或者是基于rocketmq实现，或者是自己基于这种思想实现。</p><h4 id="_1-10-总结" tabindex="-1"><a class="header-anchor" href="#_1-10-总结" aria-hidden="true">#</a> 1.10. 总结</h4><p>不建议在系统中过多使用分布式事务的。因为在真正的业务系统中代码层面造成的bug问题是少之又少的，我们可以采用报警机制、日志记录、快速定位、排查和解决问题、处理数据的方式进行处理这些因为分布式事务造成的问题。因为如果采用分布式事务的方式，代码复杂度肯定会增加，并且由于引入分布式事务造成的代码bug可能会比没有采用分布事务产生的bug还要多。</p><p>我们只需要定期的对出错的数据进行代码人工补偿即可。采用的方式就是写一个补偿程序，对错误数据进行回滚、修复等。</p><p>这种事后人工补偿的方式所花费的成本要少的多得多。</p><figure><img src="/assets/1699929333868-0fbccde3.png" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><h4 id="_1-11-附言" tabindex="-1"><a class="header-anchor" href="#_1-11-附言" aria-hidden="true">#</a> 1.11. 附言</h4><p>分布式事务中除了上述所涉及到的分布式事务以外，还有另外一种不一致的问题：就是当做一些涉及到多个服务模块的组合操作时，我们可以通过上述方式进行分布式事务的控制，分布式事务解决了动作发生时刻所产生的不一致性问题，但是分布式系统中还有一种原因也会造成分布式系统中数据不一致性的问题。那就是，如果a系统和b系统中都存了一些公共信息，而b系统中又是以a系统中的为主，那如果a系统修改了b系统，如果不做任何动作，那么就会造成a系统和b系统的数据不一致性。</p><p>此时的方式大概有三种：</p><blockquote><p>前提：我们在设计分布式系统时，要求每一个微服务只能对应一个数据库，如果一个微服务要修改不属于自己的数据库中的数据，要通过调用其他微服务接口的方式进行修改，坚决不允许直连数据库进行修改。</p></blockquote><ol><li>如果对一致性要求不那么严格，可以使用定时任务的方式：即b系统中设置一个定时任务，通过不断轮询的方式来获取更新，就是通过拿着b系统中的关键信息去a系统中获取数据后再更新到b系统中，但是这种方式需要轮询所有数据（因为不确定那些数据做了修改），再加上如果多个系统都依赖a系统的数据，那么每个依赖系统中都需要设置定时任务，对于开发人员来说补偿的工作量不小。除此以外，在a系统修改数据之后与定时任务执行之前之间数据肯定是不一致的。</li><li>如果对一致性比较严格，还可以采用关键系统异步通知的方式，即a系统修改关键数据时，同时调用b系统接口，通知b系统更新数据。但是这种涉及到a系统的改造工作。当然也可以采用异步通知的方式，即系统中引入消息机制，a系统修改数据时，往消息队列中放松一条消息，然后b系统消费数据即可，但是这种方案由于引入了消息机制，导致系统的复杂度升高，相对应的可用性降低。</li><li>如果对一致性要求非常严格，可以采用只在b系统中保存关键数据的id信息，b系统每次使用a系统中的数据时，就采用调用接口的方式即可。但是这种方式也有问题，即a系统如果出现异常情况，这会造成b系统无法获取到关键数据的其他信息。</li><li>如果是早期系统，在设计时，大多情况都采用第二种方式，异步调用的方式。</li></ol><p>选取准则： 根据不同方式的特点，看业务情况进行选择。</p><h3 id="_2-seata的at、tcc、saga和xa事务模式" tabindex="-1"><a class="header-anchor" href="#_2-seata的at、tcc、saga和xa事务模式" aria-hidden="true">#</a> 2. Seata的AT、TCC、SAGA和XA事务模式</h3><ul><li><a href="https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&amp;mid=2247494827&amp;idx=1&amp;sn=aa5d7401d53b1ca61b5e49462262bd22&amp;chksm=cea1a360f9d62a761dff15a682f69fcacdd5b70a8afc4e1114cc7f6704b31d9aa3ad82ae5233&amp;token=2092405348&amp;lang=zh_CN#rd" target="_blank" rel="noopener noreferrer">阿里终面：分布式事务原理<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://mp.weixin.qq.com/s?__biz=Mzg5Mjc3MjIyMA==&amp;mid=2247544315&amp;idx=1&amp;sn=1918fe3e5435e2ffd88aa29b76c2e35b&amp;source=41#wechat_redirect" target="_blank" rel="noopener noreferrer">聊一聊分布式事务<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://juejin.cn/post/6867040340797292558" target="_blank" rel="noopener noreferrer">消息队列之事务消息，RocketMQ 和 Kafka 是如何做的？<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://jeremyxu2010.github.io/2020/03/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%96%B9%E6%A1%88/#heading-3" target="_blank" rel="noopener noreferrer">微服务中的分布式事务方案<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li></li></ul><p>本地事务： 全局事务： 分支事务：</p><figure><img src="/assets/1699778573935-2df6dc11.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol><li>一个服务操作同一个数据库不同表中的数据；</li><li>一个服务操作不同数据库的不同表中的数据；</li><li></li></ol><p>分布式事务实现时应该关注的要点有哪些？</p><ol><li>应用程序层面： <ol><li>最终功能的完成度。考虑是否允许有一定的延时性；</li><li>架构和代码的侵入性。考虑是否需要引入新的组件、组件是否需要额外的服务器资源、引入新组件后对已有业务的影响；</li><li>性能。 <ol><li>吞吐量。原则上是要求分布式事务的实现不能降低系统的吞吐量，不能说同一个系统的接口的 QPS 相差过多，比如使用了分布式事务之后不能和之前没有使用分布式事务的接口的 QPS 相差一个量级，如果差了一个量级，就要考虑引入分布式事务的必要性；这个考虑点主要是看分布式事务中各个事务分支是否能够支持异步等。</li><li>耗时时间。同样，也不能过多的增加耗时时间，这个指标要根据软件质量要求标准可适当取舍。</li><li>并发性能。同样，也需要根据软件质量要求，适当取舍。这个考虑点主要是看分布式事务中各个事务分支是否能够支持异步等。</li></ol></li></ol></li><li>数据库层面： <ol><li>是否支持异构的数据库存储技术；</li><li>数据库并发性能；</li></ol></li><li>整体架构层面： <ol><li>引入组件带来的复杂性提升、可用性降低、需要额外的维护成本；</li><li>技术人员的学习成本等；</li></ol></li></ol><p>事务性提交 系统高可用 数据最终一致性 支持服务独立演化和部署 支持服务使用异构的数据存储技术 架构侵入性低，易于采用 支持同步和异步流程 支持事务步骤依赖</p></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/vongdefu/vongdefu.github.io/edit/main/demo/theme-docs/src/05-distribution/distribution/transaction.md" rel="noopener noreferrer" target="_blank" aria-label="编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><!----><!----></div></footer><nav class="page-nav"><a href="/05-distribution/distribution/theory.html" class="nav-link prev" aria-label="基础理论"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><!---->基础理论</div></a><!----></nav><div class="giscus-wrapper input-top" id="comment" style="display:block;"><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer">浪漫骑士的二流键盘</div><div class="copyright">Copyright © 2025 vongdefu</div></footer></div><!--]--><!----><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-fb6938a2.js" defer></script>
  </body>
</html>
