import{_ as i,W as o,X as c,Y as n,Z as s,$ as e,a0 as t,C as l}from"./framework-16b96b76.js";const d="data:image/png;base64,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",p="/assets/1699933291836-4a3515d0.png",r="/assets/1699933291925-e18f29fa.png",u="/assets/1699933292028-5f60d620.png",v="/assets/1699933292129-e2f36d68.png",m="/assets/1699933292251-dd4d2ae0.png",b="/assets/1699933293626-1d873855.png",k="/assets/1699933293759-c98e0586.png",g="/assets/1699933293876-e14c42a0.png",f="/assets/1699933293990-380d99e9.png",T="/assets/1699933294175-71272321.png",y="/assets/1699933294281-2aa3362f.png",E="/assets/1699933294381-4f0aef5f.png",_="/assets/1699933294515-687989c7.png",N="/assets/1699933294615-d0297829.png",L="/assets/1699944644888-8c0d65ff.jpg",h="/assets/1699944644987-3dae7b1f.jpg",C="/assets/1699944645086-2e9e7cdc.jpg",A="/assets/1699944645188-fd870b5b.jpg",w="/assets/1699944645340-f1e5a0b2.jpg",M="/assets/1699944645438-91410894.jpg",U="/assets/1699944645532-85470a88.jpg",x="/assets/1699944645672-b42050c5.jpg",I="/assets/1699944645764-4b18ffe7.jpg",R="/assets/1699944645859-d675d438.jpg",S="/assets/1699944645958-13b23f06.jpg",O="/assets/1699944646061-872ccc73.jpg",q="/assets/1699944646172-581fca17.jpg",D="/assets/1699944646281-2a36f6d0.jpg",F="/assets/1699944646387-3acb2e26.jpg",Y="/assets/1699944646501-4b9564fa.jpg",B={},H=t('<h1 id="_8-seata分布式事务" tabindex="-1"><a class="header-anchor" href="#_8-seata分布式事务" aria-hidden="true">#</a> 8. seata分布式事务</h1><h3 id="_1-搭建-seata-服务端" tabindex="-1"><a class="header-anchor" href="#_1-搭建-seata-服务端" aria-hidden="true">#</a> 1. 搭建 Seata 服务端</h3><h4 id="_1-1-前置知识" tabindex="-1"><a class="header-anchor" href="#_1-1-前置知识" aria-hidden="true">#</a> 1.1. 前置知识</h4><p>在了解Seata之前，请先熟悉一下分布式事务的相关知识——<a href="../../../cs-tips/docs/docs/docs/spring/seata_distribute-transaction">分布式事务概述</a>。简单熟悉一下XA模式、两阶段提交、三阶段提交、TCC、Seaga等概念及原理。</p>',4),z={href:"https://seata.io",target:"_blank",rel:"noopener noreferrer"},G=n("p",null,"Seata的用法其实很简单，我们类比于在SpringBoot项目中使用Mysql的方式——先部署一个Mysql服务器实例，然后SpringBoot项目中引入依赖，之后在配置文件中配置好Mysql的相关连接信息，之后启动即可使用，在SpringBoot项目中使用Seata的方式也很简单：",-1),P=n("ol",null,[n("li",null,"搭建一个Seata的服务器实例，这个服务器实例承担的角色是TC的角色，即事务管理器的角色；"),n("li",null,"在SpringBoot项目中引入依赖；"),n("li",null,"在配置文件中配置好Seata的相关信息；")],-1),W=n("p",null,"我们结合XA理论可知，Seata服务器端实例承载着事务管理器的角色，它承担着统一管理各个『参与者』提交事务、回滚事务的职责；而参与分布式事务的各个『参与者』就是AP的角色，它们则是具体的业务实现，底层连接着数据库，而数据库就是资源管理器（CRM）的角色。",-1),j=n("p",null,"因此，要基于Seata完成分布式事务的实现，就必须先要搭建一个Seata服务端实例。",-1),X=n("p",null,"由于Seata也是JAVA项目，并且支持多种配置方式和持久化方式，这里我们选择基于Nacos和Mysql的方式。其他方式可以自行查看官网。",-1),K=n("p",null,"因此有一个前置条件，要先把Mysql和Nacos启动起来。此外，我们还需要用到源码文件夹下面的一些脚本。因此我们还需要下载相对应版本的源代码。",-1),V={href:"https://github.com/seata/seata/releases/download/v1.3.0/seata-server-1.3.0.tar.gz",target:"_blank",rel:"noopener noreferrer"},Q={href:"https://github.com/seata/seata/tree/master/script",target:"_blank",rel:"noopener noreferrer"},Z=t('<p>总结一下：</p><ol><li>启动Mysql</li><li>启动Nacos</li><li>下载服务器端压缩包</li><li>下载源代码中的脚本</li></ol><h4 id="_1-2-搭建过程" tabindex="-1"><a class="header-anchor" href="#_1-2-搭建过程" aria-hidden="true">#</a> 1.2. 搭建过程</h4><h5 id="_1-2-1-解压" tabindex="-1"><a class="header-anchor" href="#_1-2-1-解压" aria-hidden="true">#</a> 1.2.1. 解压</h5><p>安装包下载完成之后，上传到服务器上，并完成解压。解压后的文件目录如下：</p><figure><img src="'+d+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h5 id="_1-2-2-执行脚本" tabindex="-1"><a class="header-anchor" href="#_1-2-2-执行脚本" aria-hidden="true">#</a> 1.2.2. 执行脚本</h5><p>Seata本身也是一个项目，这个执行脚本的过程，本质上就是对Seata进行一个配置。执行脚本有两个步骤，一个是Seata在管理分布式事务时，需要依赖数据库保存一些关键信息；一个是需要导入Seata项目的一些配置信息。<strong>此外，这两个脚本都是在源码项目下面的。</strong></p><p>步骤一，在下载下来的源代码目录下，找到/script/server/db/下面的mysql的脚本，并在mysql中进行执行。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>-- -------------------------------- The script used when storeMode is &#39;db&#39; --------------------------------\n-- the table to store GlobalSession data\nCREATE TABLE IF NOT EXISTS `global_table`\n(\n    `xid`                       VARCHAR(128) NOT NULL,\n    `transaction_id`            BIGINT,\n    `status`                    TINYINT      NOT NULL,\n    `application_id`            VARCHAR(32),\n    `transaction_service_group` VARCHAR(32),\n    `transaction_name`          VARCHAR(128),\n    `timeout`                   INT,\n    `begin_time`                BIGINT,\n    `application_data`          VARCHAR(2000),\n    `gmt_create`                DATETIME,\n    `gmt_modified`              DATETIME,\n    PRIMARY KEY (`xid`),\n    KEY `idx_gmt_modified_status` (`gmt_modified`, `status`),\n    KEY `idx_transaction_id` (`transaction_id`)\n) ENGINE = InnoDB\n  DEFAULT CHARSET = utf8;\n\n-- the table to store BranchSession data\nCREATE TABLE IF NOT EXISTS `branch_table`\n(\n    `branch_id`         BIGINT       NOT NULL,\n    `xid`               VARCHAR(128) NOT NULL,\n    `transaction_id`    BIGINT,\n    `resource_group_id` VARCHAR(32),\n    `resource_id`       VARCHAR(256),\n    `branch_type`       VARCHAR(8),\n    `status`            TINYINT,\n    `client_id`         VARCHAR(64),\n    `application_data`  VARCHAR(2000),\n    `gmt_create`        DATETIME(6),\n    `gmt_modified`      DATETIME(6),\n    PRIMARY KEY (`branch_id`),\n    KEY `idx_xid` (`xid`)\n) ENGINE = InnoDB\n  DEFAULT CHARSET = utf8;\n\n-- the table to store lock data\nCREATE TABLE IF NOT EXISTS `lock_table`\n(\n    `row_key`        VARCHAR(128) NOT NULL,\n    `xid`            VARCHAR(96),\n    `transaction_id` BIGINT,\n    `branch_id`      BIGINT       NOT NULL,\n    `resource_id`    VARCHAR(256),\n    `table_name`     VARCHAR(32),\n    `pk`             VARCHAR(36),\n    `gmt_create`     DATETIME,\n    `gmt_modified`   DATETIME,\n    PRIMARY KEY (`row_key`),\n    KEY `idx_branch_id` (`branch_id`)\n) ENGINE = InnoDB\n  DEFAULT CHARSET = utf8;\n\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="'+p+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>步骤二，导入Seata项目的一些配置信息到nacso上去，由于配置项比较多，官方提供了使用脚本进行导入的方式，这个过程可能需要具备一些Nacos的基本知识。</p><p>但是由于我们使用的配置方式是基于mysql和nacos的，因此，我们还需要先修改一下配置信息。我们打开 /script/config-center/ 下面的 config.txt 文件，之后修改下面的几项内容：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>
store.mode=db ## 采用db的存储形式 
store.db.datasource=druid ## druid数据源 
store.db.dbType=mysql ## mysql数据库 
store.db.driverClassName=com.mysql.jdbc.Driver ## mysql驱动 
store.db.url=jdbc:mysql://192.168.1.150:3306/seata_server?useUnicode=true ## TC的数据库url 
store.db.user=root ## 用户名 
store.db.password=root ## 密码

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最后只需要在 /script/config-center/nacos/ 目录下执行下面命令即可。Windows平台下面，可以使用gitbash执行。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>sh nacos-config.sh -h 192.168.1.150 -p 8848 -g SEATA_GROUP -t bb4ba084-9183-4406-bdf4-9254d372849e -u nacos -w nacos

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>执行后的效果如下：</p><figure><img src="`+r+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h5 id="_1-2-3-修改项目中的配置文件" tabindex="-1"><a class="header-anchor" href="#_1-2-3-修改项目中的配置文件" aria-hidden="true">#</a> 1.2.3. 修改项目中的配置文件</h5><p>完成上面的两个步骤之后，Seata的基础环境已经完成了，下面需要配置Seata项目的启动信息，主要是： 让Seata服务实例注册到nacos上 和 让Seata找到Nacos上的配置信息 ，也很简单，<strong>只需要修改安装包下面的 conf/registry.conf 文件中的nacos部分即可</strong>。修改后的结果如下：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>## 【说明】文件有两部分，一个是registry，表示Seata服务端程序注册到哪里，这里我们把type配置成nacos，然后修改nacos的连接信息即可。
##      另一部分是config，表示Seata服务端程序的配置信息放在哪里，同样的，我们把type改成nacos，然后修改nacos的连接信息即可。

registry {
  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa
  type = &quot;nacos&quot;

  nacos {
    application = &quot;seata-server&quot;
    serverAddr = &quot;192.168.1.150:8848&quot;
    group = &quot;SEATA_GROUP&quot;
    namespace = &quot;bb4ba084-9183-4406-bdf4-9254d372849e&quot;
    cluster = &quot;default&quot;
    username = &quot;nacos&quot;
    password = &quot;nacos&quot;
  }
  eureka {
    serviceUrl = &quot;http://localhost:8761/eureka&quot;
    application = &quot;default&quot;
    weight = &quot;1&quot;
  }
  redis {
    serverAddr = &quot;localhost:6379&quot;
    db = 0
    password = &quot;&quot;
    cluster = &quot;default&quot;
    timeout = 0
  }
  zk {
    cluster = &quot;default&quot;
    serverAddr = &quot;127.0.0.1:2181&quot;
    sessionTimeout = 6000
    connectTimeout = 2000
    username = &quot;&quot;
    password = &quot;&quot;
  }
  consul {
    cluster = &quot;default&quot;
    serverAddr = &quot;127.0.0.1:8500&quot;
  }
  etcd3 {
    cluster = &quot;default&quot;
    serverAddr = &quot;http://localhost:2379&quot;
  }
  sofa {
    serverAddr = &quot;127.0.0.1:9603&quot;
    application = &quot;default&quot;
    region = &quot;DEFAULT_ZONE&quot;
    datacenter = &quot;DefaultDataCenter&quot;
    cluster = &quot;default&quot;
    group = &quot;SEATA_GROUP&quot;
    addressWaitTime = &quot;3000&quot;
  }
  file {
    name = &quot;file.conf&quot;
  }
}

config {
  # file、nacos 、apollo、zk、consul、etcd3
  type = &quot;nacos&quot;

  nacos {
    serverAddr = &quot;192.168.1.150:8848&quot;
    namespace = &quot;bb4ba084-9183-4406-bdf4-9254d372849e&quot;
    group = &quot;SEATA_GROUP&quot;
    username = &quot;nacos&quot;
    password = &quot;nacos&quot;
  }
  consul {
    serverAddr = &quot;127.0.0.1:8500&quot;
  }
  apollo {
    appId = &quot;seata-server&quot;
    apolloMeta = &quot;http://192.168.1.204:8801&quot;
    namespace = &quot;application&quot;
  }
  zk {
    serverAddr = &quot;127.0.0.1:2181&quot;
    sessionTimeout = 6000
    connectTimeout = 2000
    username = &quot;&quot;
    password = &quot;&quot;
  }
  etcd3 {
    serverAddr = &quot;http://localhost:2379&quot;
  }
  file {
    name = &quot;file.conf&quot;
  }
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_1-2-4-启动" tabindex="-1"><a class="header-anchor" href="#_1-2-4-启动" aria-hidden="true">#</a> 1.2.4. 启动</h5>`,22),J={href:"http://seata-server.sh",target:"_blank",rel:"noopener noreferrer"},$=t('<figure><img src="'+u+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>查看日志中，已经成功启动。</p><figure><img src="'+v+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>再去nacos上看看，服务实例已经启动，并注册到了Nacos上了。</p><figure><img src="'+m+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_2-at-模式实战" tabindex="-1"><a class="header-anchor" href="#_2-at-模式实战" aria-hidden="true">#</a> 2. AT 模式实战</h3><h4 id="_2-1-使用场景" tabindex="-1"><a class="header-anchor" href="#_2-1-使用场景" aria-hidden="true">#</a> 2.1. 使用场景</h4><p>举一个简单的应用场景：电商系统中，一个用户发起购买商品的动作，后端业务逻辑是</p><ul><li>扣减库存</li><li>扣减个人账户上的余额</li><li>创建一个订单</li></ul><p>只要上面有一个步骤没有执行成功，就回滚已经执行成功的其他步骤。为了模拟分布式事务的效果，我们采用创建三个微服务的方式实现。</p><ol><li>seata-at-storage 库存服务</li><li>seata-at-account 账户服务</li><li>seata-at-order 订单服务</li></ol><p>所以上面的业务逻辑就变成了，用户发起一个购买商品的服务，直接调用后端 订单服务 ，由订单服务分别调用 库存服务 完成扣减库存功能，然后再调用 账户服务 完成扣减账户金额功能，最后本地生成一个订单。</p><p>这里我们需要一个注册中心，把三个服务注册到上面，这样配合OpenFeign完成相互调用，此外我们还需要MySQL作为数据存储，最后我们需要Seata作为我们的事务管理器。</p><h4 id="_2-2-搭建seata-at-storage服务模块" tabindex="-1"><a class="header-anchor" href="#_2-2-搭建seata-at-storage服务模块" aria-hidden="true">#</a> 2.2. 搭建seata-at-storage服务模块</h4><ol><li>先创建数据库</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>-- 仓储
CREATE TABLE \`storage\` (
  \`id\` bigint(11) NOT NULL AUTO_INCREMENT,
  \`name\` varchar(100) DEFAULT NULL,
  \`num\` bigint(11) DEFAULT NULL COMMENT &#39;数量&#39;,
  \`create_time\` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;,
  \`price\` bigint(10) DEFAULT NULL COMMENT &#39;单价，单位分&#39;,
  PRIMARY KEY (\`id\`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=COMPACT;

CREATE TABLE \`undo_log\` (
  \`branch_id\` bigint(20) NOT NULL COMMENT &#39;branch transaction id&#39;,
  \`xid\` varchar(100) NOT NULL COMMENT &#39;global transaction id&#39;,
  \`context\` varchar(128) NOT NULL COMMENT &#39;undo_log context,such as serialization&#39;,
  \`rollback_info\` longblob NOT NULL COMMENT &#39;rollback info&#39;,
  \`log_status\` int(11) NOT NULL COMMENT &#39;0:normal status,1:defense status&#39;,
  \`log_created\` datetime(6) NOT NULL COMMENT &#39;create datetime&#39;,
  \`log_modified\` datetime(6) NOT NULL COMMENT &#39;modify datetime&#39;,
  UNIQUE KEY \`ux_undo_log\` (\`xid\`,\`branch_id\`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=COMPACT COMMENT=&#39;AT transaction mode undo table&#39;;

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>使用idea工具中的initializer工具，生成模块的骨架，这里不再赘述。</li><li>修改pom文件，添加上 nacos注册中心、Mybatis、MySQL、Seata的相关依赖。</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;
  &lt;/dependency&gt;

  &lt;dependency&gt;
    &lt;groupId&gt;com.baomidou&lt;/groupId&gt;
    &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;
  &lt;/dependency&gt;

  &lt;!-- mysql --&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;mysql&lt;/groupId&gt;
    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
  &lt;/dependency&gt;

  &lt;!--seata--&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-seata&lt;/artifactId&gt;
    &lt;exclusions&gt;
      &lt;!-- 排除依赖 指定版本和服务器端一致 --&gt;
      &lt;exclusion&gt;
        &lt;groupId&gt;io.seata&lt;/groupId&gt;
        &lt;artifactId&gt;seata-all&lt;/artifactId&gt;
      &lt;/exclusion&gt;
      &lt;exclusion&gt;
        &lt;groupId&gt;io.seata&lt;/groupId&gt;
        &lt;artifactId&gt;seata-spring-boot-starter&lt;/artifactId&gt;
      &lt;/exclusion&gt;
    &lt;/exclusions&gt;
  &lt;/dependency&gt;

  &lt;dependency&gt;
    &lt;groupId&gt;io.seata&lt;/groupId&gt;
    &lt;artifactId&gt;seata-all&lt;/artifactId&gt;
  &lt;/dependency&gt;

  &lt;dependency&gt;
    &lt;groupId&gt;io.seata&lt;/groupId&gt;
    &lt;artifactId&gt;seata-spring-boot-starter&lt;/artifactId&gt;
  &lt;/dependency&gt;

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>修改项目的配置： application.yml</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>server:
  port: 10902

spring:
  application:
    name: seata-at-storage
  datasource:
    url: jdbc:mysql://192.168.1.150:3306/seata_storage?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai
    username: root
    password: root
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      auto-commit: true
      connection-test-query: SELECT 1
      connection-timeout: 30000
      idle-timeout: 180000
      max-lifetime: 0
      maximum-pool-size: 30
      minimum-idle: 10
      pool-name: hikari-pool
  cloud:
    nacos:
      discovery:
        server-addr: 192.168.1.150:8848
        namespace: 2cbceeeb-22f5-40d6-b65c-47f673e79f29


mybatis:
  mapper-locations: classpath:/mapper/*.xml

# 配置日志级别
logging:
  level:
    root: debug

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>之后再使用idea中的easycode插件生成业务代码，关键方法是： <code>me.zeanzai.seataatstorage.service.impl.StorageServiceImpl#deduct</code></li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Transactional
@Override
public boolean deduct(Long id, Long num) {
    //todo 模拟扣减库存，具体业务逻辑自己完善
    Storage storage = this.storageDao.queryById(id);
    if (Objects.isNull(storage))
        throw new RuntimeException();

    storage.setNum(storage.getNum()-num);

    return this.storageDao.update(storage) &gt; 0;
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-搭建seata-at-account和seata-at-order服务模块" tabindex="-1"><a class="header-anchor" href="#_2-3-搭建seata-at-account和seata-at-order服务模块" aria-hidden="true">#</a> 2.3. 搭建seata-at-account和seata-at-order服务模块</h4><p>搭建过程与上面的seata-at-storage服务模块的过程基本类似。</p><p>seata-at-account的表结构：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>
<span class="token comment">-- 账户余额</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">\`</span>account<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span>
	<span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span> <span class="token keyword">BIGINT</span> <span class="token punctuation">(</span> <span class="token number">11</span> <span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
	<span class="token identifier"><span class="token punctuation">\`</span>user_id<span class="token punctuation">\`</span></span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">32</span> <span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;用 户userId&#39;</span><span class="token punctuation">,</span>
	<span class="token identifier"><span class="token punctuation">\`</span>money<span class="token punctuation">\`</span></span> <span class="token keyword">BIGINT</span> <span class="token punctuation">(</span> <span class="token number">11</span> <span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;余额，单位分&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>create_time<span class="token punctuation">\`</span></span> <span class="token keyword">timestamp</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;创建时间&#39;</span><span class="token punctuation">,</span>
	<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span> <span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span> <span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span> 
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">INNODB</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_general_ci ROW_FORMAT <span class="token operator">=</span> Compact<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">\`</span>undo_log<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">\`</span>branch_id<span class="token punctuation">\`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;branch transaction id&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>xid<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;global transaction id&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>context<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;undo_log context,such as serialization&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>rollback_info<span class="token punctuation">\`</span></span> <span class="token keyword">longblob</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;rollback info&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>log_status<span class="token punctuation">\`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;0:normal status,1:defense status&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>log_created<span class="token punctuation">\`</span></span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;create datetime&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>log_modified<span class="token punctuation">\`</span></span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;modify datetime&#39;</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">\`</span>ux_undo_log<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>xid<span class="token punctuation">\`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">\`</span>branch_id<span class="token punctuation">\`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 ROW_FORMAT<span class="token operator">=</span>COMPACT <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">&#39;AT transaction mode undo table&#39;</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>seata-at-order服务模块的表结构：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>

-- 订单
CREATE TABLE \`ordertb\` (
  \`id\` bigint(11) NOT NULL AUTO_INCREMENT,
  \`product_id\` bigint(11) DEFAULT NULL COMMENT &#39;商品Id&#39;,
  \`num\` bigint(11) DEFAULT NULL COMMENT &#39;数量&#39;,
  \`user_id\` varchar(32) DEFAULT NULL COMMENT &#39;用户唯一Id&#39;,
  \`create_time\` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;,
  \`status\` int(1) DEFAULT NULL COMMENT &#39;订单状态 1 未付款 2 已付款 3 已完成&#39;,
  PRIMARY KEY (\`id\`) USING BTREE
) ENGINE=InnoDB CHARACTER SET = utf8mb4 COLLATE = utf8mb4_general_ci  ROW_FORMAT=COMPACT;

CREATE TABLE \`undo_log\` (
  \`branch_id\` bigint(20) NOT NULL COMMENT &#39;branch transaction id&#39;,
  \`xid\` varchar(100) NOT NULL COMMENT &#39;global transaction id&#39;,
  \`context\` varchar(128) NOT NULL COMMENT &#39;undo_log context,such as serialization&#39;,
  \`rollback_info\` longblob NOT NULL COMMENT &#39;rollback info&#39;,
  \`log_status\` int(11) NOT NULL COMMENT &#39;0:normal status,1:defense status&#39;,
  \`log_created\` datetime(6) NOT NULL COMMENT &#39;create datetime&#39;,
  \`log_modified\` datetime(6) NOT NULL COMMENT &#39;modify datetime&#39;,
  UNIQUE KEY \`ux_undo_log\` (\`xid\`,\`branch_id\`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=COMPACT COMMENT=&#39;AT transaction mode undo table&#39;;

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>扣减金额的关键代码， <code>me.zeanzai.seataataccount.service.impl.AccountServiceImpl#deduct</code> ：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Transactional
@Override
public boolean deduct(String userId, Long money) {
    Account account = this.accountDao.queryByUserId(userId);
    if (Objects.isNull(account)) {
        return false;

    }
    account.setMoney(account.getMoney()-money);
    return this.accountDao.update(account)&gt;0;
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于 seata-at-order 服务模块中需要使用OpenFeign来调用仓储和账户服务，因此还需要创建两个接口：</p><figure><img src="`+b+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@FeignClient(value = &quot;seata-at-account&quot;)
public interface AccountFeignClient {

    @PostMapping(&quot;/account/deduct&quot;)
    boolean deduct(@RequestParam(&quot;userId&quot;) String userId,
                   @RequestParam(&quot;money&quot;) Long money);

}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@FeignClient(value = &quot;seata-at-storage&quot;)
public interface StorageFeignClient {

    @GetMapping(&quot;/storage/{id}&quot;)
    ResponseEntity&lt;Storage&gt; queryById(@PathVariable(&quot;id&quot;) Long id);

    @PostMapping(&quot;/storage/deduct&quot;)
    boolean deduct(@RequestParam(&quot;id&quot;) Long id,
                   @RequestParam(&quot;num&quot;) Long num);
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>之后就是生成订单的关键代码， <code>me.zeanzai.seataatorder.service.impl.OrdertbServiceImpl#createOrder</code> ：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Transactional
@Override
public boolean createOrder(String userId, Long productId, Long num) {
    // 1. 扣减库存
    storageFeignClient.deduct(productId, num);

    // 2. 扣减余额
    ResponseEntity&lt;Storage&gt; storageResponseEntity = storageFeignClient.queryById(productId);
    Storage body = storageResponseEntity.getBody();
    accountFeignClient.deduct(userId, body.getPrice() * num);
    // 3. 创建订单
    Ordertb ordertb = new Ordertb();
    ordertb.setNum(num);
    ordertb.setUserId(userId);
    ordertb.setProductId(productId);
    ordertb.setStatus(2);
    return this.ordertbDao.insert(ordertb)&gt;0;
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-4-启动并测试" tabindex="-1"><a class="header-anchor" href="#_2-4-启动并测试" aria-hidden="true">#</a> 2.4. 启动并测试</h4><p>分别启动 seata-at-storage 、 seata-at-account 、seata-at-order 模块，我们会发现已经注册到nacos上了。</p><figure><img src="`+k+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>之后我们只需要调用订单模块中的createOrder接口就行了。</p><p>特别注意的点：三个服务模块中都只是使用<code>@Transactional</code>标注了本地事务，并没有开始分布式事务。</p><h4 id="_2-5-整合seata" tabindex="-1"><a class="header-anchor" href="#_2-5-整合seata" aria-hidden="true">#</a> 2.5. 整合Seata</h4><p>直到这一步，我们跟Seata没有任何关系，因为我们生成订单的方法中并没有定义事务，只是简单的本地事务，在生成订单的接口中，如果扣减库存的接口出现超时等异常错误信息，扣减金额和生成订单的逻辑并不会回滚。下面我们来说整合Seata的过程。安装和配置Seata这里就不再赘述。</p><ol><li>首先要先启动Seata</li></ol><figure><img src="'+g+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol start="2"><li>在三个模块中分别添加Seata的配置</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>seata:
  enabled: true
  application-id: \${spring.application.name}
  tx-service-group: \${spring.application.name}-tx-group
  config:
    type: nacos
    nacos:
      namespace: bb4ba084-9183-4406-bdf4-9254d372849e
      server-addr: 192.168.1.150:8848
      group: SEATA_GROUP
      username: nacos
      password: nacos
  registry:
    type: nacos
    nacos:
      application: seata-server
      namespace: bb4ba084-9183-4406-bdf4-9254d372849e
      server-addr: 192.168.1.150:8848
      group: SEATA_GROUP
      username: nacos
      password: nacos

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>创建Seata服务端配置，这里要特别注意：值均为default。</li></ol><figure><img src="`+f+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+T+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+y+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+E+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol start="4"><li>修改业务代码，在订单模块中设置生成订单的方法为全局事务</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Override
@GlobalTransactional
public boolean createOrder(String userId, Long productId, Long num) {
    // 1. 扣减库存
    storageFeignClient.deduct(productId, num);

    // 2. 扣减余额
    ResponseEntity&lt;Storage&gt; storageResponseEntity = storageFeignClient.queryById(productId);
    Storage body = storageResponseEntity.getBody();
    accountFeignClient.deduct(userId, body.getPrice() * num);
    // 3. 创建订单
    Ordertb ordertb = new Ordertb();
    ordertb.setNum(num);
    ordertb.setUserId(userId);
    ordertb.setProductId(productId);
    ordertb.setStatus(2);
    return this.ordertbDao.insert(ordertb)&gt;0;
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>启动测试</li></ol><figure><img src="`+_+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+N+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_3-tcc-模式实战" tabindex="-1"><a class="header-anchor" href="#_3-tcc-模式实战" aria-hidden="true">#</a> 3. TCC 模式实战</h3><ol><li>搭建公共模块，并搭建三个基本服务，完成三个模块的接口测试；</li><li>保证三个异常</li></ol><p>第一阶段： 搭建基础环境，只提供操作数据库的方法； 第二阶段： 完成order模块调用另外两个模块的rpc调用过程，需要集成nacos、openfeign等工具包； 第三阶段： 集成Seata；</p><p>starter模块用来统一管理各种依赖的版本； common模块继承starter模块，并包含公共模块，但是不传递依赖，如Seata的依赖，如果只在业务包里面使用，那么Seata的依赖就应该放到业务模块里面；</p><p>遵循： 1. 用到才添加依赖，不传递；</p><p>storage、account、order都继承starter模块，并继承starter模块，依赖于common模块；</p><ol><li>需要解决空回滚</li><li>悬挂</li><li>幂等</li></ol><p>// todo // 1. 单测已经完成，但是压测没有通过，大批量请求进入时，并不能保证数据的一致性； // 2. 码猿技术专栏教程中的项目代码，压测时，也不能保证数据的一致性； // 3. 参考网上一篇文章，完成了异常编码集中化配置的使用方式，但是理想是把配置文件整到配置中心去；</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>storage<span class="token punctuation">`</span></span>  <span class="token punctuation">(</span>\n  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>product_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>num<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;数量&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>price<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;单价，单位分&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>frozen<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;冻结的库存&#39;</span><span class="token punctuation">,</span>\n  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>\n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_general_ci ROW_FORMAT <span class="token operator">=</span> Compact<span class="token punctuation">;</span>\n\n<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>account<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>\n	<span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span> <span class="token punctuation">(</span> <span class="token number">11</span> <span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>\n	<span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">32</span> <span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;用 户userId&#39;</span><span class="token punctuation">,</span>\n	<span class="token identifier"><span class="token punctuation">`</span>money<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span> <span class="token punctuation">(</span> <span class="token number">11</span> <span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;余额，单位分&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">timestamp</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;创建时间&#39;</span><span class="token punctuation">,</span>\n\n  <span class="token identifier"><span class="token punctuation">`</span>frozen<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;冻结的money&#39;</span><span class="token punctuation">,</span>\n	<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span> <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span> \n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">INNODB</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_general_ci ROW_FORMAT <span class="token operator">=</span> Compact<span class="token punctuation">;</span>\n\n<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t_order<span class="token punctuation">`</span></span>  <span class="token punctuation">(</span>\n  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>order_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;订单Id&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>product_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;商品Id&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>num<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;数量&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;用户唯一Id&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;订单状态 1 未付款 2 已付款 3 已完成 4 待确认 5 已删除&#39;</span><span class="token punctuation">,</span>\n  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>\n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_general_ci ROW_FORMAT <span class="token operator">=</span> Compact<span class="token punctuation">;</span>\n\n<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>ordertb<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>\n  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>order_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;订单Id&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>product_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;商品Id&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>num<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;数量&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;用户唯一Id&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">timestamp</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;创建时间&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;订单状态 1 未付款 2 已付款 3 已完成 4 待确认 5 已删除&#39;</span><span class="token punctuation">,</span>\n  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>\n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_general_ci  ROW_FORMAT<span class="token operator">=</span>COMPACT<span class="token punctuation">;</span>\n\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>压力测试时用到的一些脚本</p><p>-- 初始化 delete from <code>seata_server</code>.<code>branch_table</code>; delete from <code>seata_server</code>.<code>global_table</code>; delete from <code>seata_server</code>.<code>lock_table</code>; delete from <code>seata_tcc_account</code>.<code>account</code>; delete from <code>seata_tcc_account</code>.<code>undo_log</code>; delete from <code>seata_tcc_storage</code>.<code>storage</code>; delete from <code>seata_tcc_storage</code>.<code>undo_log</code>; delete from <code>seata_tcc_order</code>.<code>ordertb</code>; delete from <code>seata_tcc_order</code>.<code>undo_log</code>; delete from <code>seata_tcc_order</code>.<code>transactional_record</code>; INSERT INTO <code>seata_tcc_account</code>.<code>account</code> (<code>id</code>, <code>user_id</code>, <code>money</code>, <code>create_time</code>, <code>frozen</code>) VALUES (1, &#39;1&#39;, 20000, &#39;2023-03-21 16:46:58&#39;, 0); INSERT INTO <code>seata_tcc_storage</code>.<code>storage</code> (<code>id</code>, <code>product_id</code>, <code>name</code>, <code>num</code>, <code>create_time</code>, <code>price</code>, <code>frozen</code>) VALUES (1, 100, &#39;码猿技术专栏&#39;, 1000, &#39;2021-10-15 22:32:40&#39;, 20, 0);</p><p>select * from <code>seata_tcc_account</code>.<code>account</code>; select * from <code>seata_tcc_storage</code>.<code>storage</code>; select * from <code>seata_tcc_order</code>.<code>ordertb</code>; select * from <code>seata_tcc_order</code>.<code>transactional_record</code>; select * from <code>seata_tcc_storage</code>.<code>undo_log</code>; select * from <code>seata_tcc_account</code>.<code>undo_log</code>; select * from <code>seata_tcc_order</code>.<code>undo_log</code>;</p><p>-- 花的钱： select (20000-money) as cost from <code>seata_tcc_account</code>.<code>account</code>;</p><p>-- 卖的产品个数： select (1000-num) as productNum from <code>seata_tcc_storage</code>.<code>storage</code>;</p><p>-- 订单个数 select count(1) as orderNum, count(1)_2 as productNum, count(1)_40 as moneyCost from <code>seata_tcc_order</code>.<code>ordertb</code> where <code>status</code>=3;</p><p>select a.cost=o.moneyCost, s.productNum=o.productNum1 from (select (20000-money) as cost from <code>seata_tcc_account</code>.<code>account</code>) a, (select (1000-num) as productNum from <code>seata_tcc_storage</code>.<code>storage</code>) s, (select count(1)_2 as productNum1, count(1)_40 as moneyCost from <code>seata_tcc_order</code>.<code>ordertb</code> where <code>status</code>=3) o ;</p><p>-- 订单上的产品个数： select sum(num) from <code>seata_tcc_order</code>.<code>ordertb</code> where <code>status</code>=3; select count(*) from <code>seata_tcc_order</code>.<code>transactional_record</code>;</p><h3 id="_4-实践过程" tabindex="-1"><a class="header-anchor" href="#_4-实践过程" aria-hidden="true">#</a> 4. 实践过程</h3><blockquote><p>使用jpa作为ORM框架； 框架是一步一步进行迭代的。</p></blockquote><ol><li>搭建项目脚手架</li><li>集成Openfeign</li><li>集成Seata</li><li>处理三个异常信息</li><li>处理幂等性问题</li><li>查看GitHub上的samples，对服务调用也要进行幂等的问题？会不会可以处理压测时出现的问题</li></ol><hr><h3 id="_5-tcc模式" tabindex="-1"><a class="header-anchor" href="#_5-tcc模式" aria-hidden="true">#</a> 5. TCC模式</h3><h4 id="_5-1-1-空回滚和悬挂问题的分析" tabindex="-1"><a class="header-anchor" href="#_5-1-1-空回滚和悬挂问题的分析" aria-hidden="true">#</a> 5.1. 1.空回滚和悬挂问题的分析</h4><p>这一节，我们来看下生单链路中，引入Seata TCC后可能会导致的一些问题，在TCC分布式事务中，最常见的问题莫过于空回滚和悬挂了，Seata TCC分布式事务也是如此。</p><p>我们先来结合着上节课的生单链路，了解下什么是空回滚和悬挂：</p><figure><img src="'+L+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>可以看到，当用户提交订单时，订单系统向Seata Server发送一个请求，开启一个分布式事务，并获取分布式事务对应的xid，然后订单系统通过dubbo，向库存系统发送一个rpc请求并传递相应的xid，请求锁定库存。</p><p>库存系统收到订单系统发送过来的xid，会在xid对应的分布式事务下，开启一个分支事务，然后调用系统中数据库缓存双写的逻辑。</p><p>在Seata TCC分布式事务中，会依次执行每个接口中的try方法，对一些资源进行预留，比如我们这里锁定库存，根据前面的约定，try方法中就是先扣减销售库存：</p><p>而第一个可能出现的问题，就是在调用try方法时，可能因为网络不通畅等原因，导致try方法调用时阻塞住，一直卡在半路当中，此时，销售库存的数据，当然也就没来得及扣减成功。</p><figure><img src="'+h+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>这个时候，Seata TCC可能还误以为写库接口中的try方法，已经执行成功了，这个时候，Seata TCC还没等到写库接口的try方法执行成功，就开始执行写缓存接口中的try方法：</p><p>可以看到，在执行写缓存接口中的try方法时，倘若是出现了任何异常的情况，根据我们前面分析的，此时，出现异常的方法，就会原地进行本地事务回滚，Seata TCC同时也会调用写库接口中的cancel方法进行回滚。</p><figure><img src="'+C+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>现在最大的问题在于，写库接口中的try方法，前面因为网络不通畅等问题，还没来得及执行成功，此时，Seata TCC就要调用写库接口的cancel方法进行回滚，对销售库存进行增加，这样就会导致销售库存，莫名其妙多出了一些库存数据，整体的库存数据就不一致了。</p><p>像这样由于网络不通畅等原因，导致在try方法都还没有执行成功的前提下，就直接执行cancel方法进行回滚的现象，我们称为空回滚，而try方法一直阻塞卡住而不能执行的现象，一般也被称为是悬挂，不管是空回滚还是悬挂，这个两个问题的出现，根据我们刚分析的，都存在一定的概率，导致库存数据的不一致。</p><h4 id="_5-2-2-seata-tcc中的幂等性问题分析" tabindex="-1"><a class="header-anchor" href="#_5-2-2-seata-tcc中的幂等性问题分析" aria-hidden="true">#</a> 5.2. 2.Seata TCC中的幂等性问题分析</h4><p>除了可能会导致空回滚和悬挂之外，Seata TCC的引入同样也会导致幂等性问题的发生：</p><p>可以看到，倘若各个接口的try方法，现在都执行成功了，接下来，Seata TCC就会依次调用各个接口中的confirm方法，完成核心的业务逻辑。</p><figure><img src="'+A+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>Seata TCC底层，一旦发现所有接口的try方法都执行成功，就会依次调用各个接口confirm方法，如果confirm方法执行失败，Seata TCC底层就会重复调用接口的confirm方法，务必确保每个接口的confirm方法，一定能执行成功。</p><p>这样的话，confirm方法就会存在一定的概率被重复调用，如图，一旦confirm方法被重复调用，锁定库存的数据就有可能被重复累加，进而导致库存数据的不一致性问题发生，所以，这算是Seata TCC分布式事务中，一个比较典型的幂等性问题了。</p><p>相应的，如果Seata TCC操作出现异常，也会导致幂等性问题的发生：</p><p>可以看到，如果写缓存接口的try方法执行失败了，写库接口这里，相应的会调用cancel方法进行回滚操作，而cancel方法的调用和confirm方法的规律是类似的，Seata TCC底层也有可能会出现重复调用，导致销售库存重复累加，进而导致库存数据的不一致性问题发生。</p><p>所以，我们可以看到，在Seata TCC分布式事务中，不论是调用confirm方法还是调用cancel方法，都存在一定的概率重复调用，也就是说confirm方法调用和cancel方法调用，都存在幂等性的问题。</p><figure><img src="'+w+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="_5-3-3-如何解决空回滚、悬挂以及幂等性问题呢" tabindex="-1"><a class="header-anchor" href="#_5-3-3-如何解决空回滚、悬挂以及幂等性问题呢" aria-hidden="true">#</a> 5.3. 3.如何解决空回滚、悬挂以及幂等性问题呢？</h4><p>我们先来分析下空回滚和悬挂的问题，看下有没有好的解决方案。 首先，空回滚和悬挂问题发生的主要原因，在于try方法都还没有执行成功，cancel方法就被调用了，导致平白无故就多补偿了一次，库存数据当然就会不一致性，所以，要是cancel方法在开始执行时，就能知道try方法是否执行成功了，问题不就好办多了吗。</p><p>基于这样的设想，我们可以在内存中设计一个缓存，比如，我们可以通过Map这样的数据结构来实现，Map中的key为接口名称、分布式事务的xid和以及商品的sku组成，表示当前是哪个接口类，在哪个Seata分布式事务中，对哪个商品sku进行锁定库存操作。</p><p>而Map中的value值，则可以用于存放具体的操作状态，比如try操作开始执行时，可以在缓存中设置“TRY_START”字符串，表示当前try方法开始执行了；而当try方法执行成功之后，可以将该value值设置为“TRY_SUCESS”字符串，表示当前try方法已经执行成功了。</p><p>接下来，我们结合着生单链路，来看下具体是如何结合缓存，来解决空回滚和悬挂问题的：</p><p>首先，在cancel方法刚开始执行时，首先到缓存中检查一下，通过接口名称+xid+sku拼接成一个key，到Map缓存中查询一下，先看下能够获取到try方法执行过的痕迹。</p><p>如果try方法都还没有执行，得到的value结果肯定就为null，此时，cancel方法中的逻辑就直接取消执行，避免空回滚逻辑的执行。</p><figure><img src="'+M+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>并且，因为当前try方法都还没有开始执行就调用cancel方法了，空回滚的问题就已经发生了，所以，我们可以事先在数据库中自定义一张表，专门用来存放空回滚的记录。</p><p>空回滚发生的同时，我们可以在数据库中，及时插入一条空回滚的记录，这样，接下来一旦try方法由于网络而恢复执行了，就可以利用数据库的空回滚记录，控制try方法的执行了，我们具体来看下：</p><figure><img src="'+U+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>可以看到，try方法执行时，首先会到数据库中检查一下，如果发现当前已经出现空回滚了，try方法就算恢复网络也不会被允许实际的去执行了，直接就取消try方法的执行了，通过以上这套思路，空回滚和悬挂的问题也就解决了。</p><p>空回滚和悬挂的问题解决了之后，confirm方法和cancel方法的幂等性问题，自然也就简单多了，前面我们分析过，当try方法开始执行时，会在缓存中以接口名称+xid+sku拼接的字符串为key，以“TRY_START”为value，一旦try方法执行完毕，value值就会被更新为“TRY_SUCESS”。</p><p>如果出现多个请求，重复调用confirm方法或者是cancel方法，首先得要检查下缓存中的value，是否为“TRY_SUCESS”，只有当try方法被执行了，且try方法还执行成功了，才允许执行confirm或cancel方法，否则，直接取消当前的方法。</p><p>毕竟，try方法都还没有执行成功，贸然就执行confirm方法和cancel方法，肯定是会存在问题的，这也是前面幂等性问题的核心。</p><p>而当confirm方法或cancel方法都执行完毕之后，缓存中的try方法执行标识也会及时清理掉，下一次有重复的请求过来时，缓存中就找不到try方法执行的痕迹了，confirm或者cancel方法也就不会被重复执行了，幂等性问题同样也就得以解决了。</p><h4 id="_5-4-4-总结" tabindex="-1"><a class="header-anchor" href="#_5-4-4-总结" aria-hidden="true">#</a> 5.4. 4.总结</h4><p>这一节，我们分析了在引入Seata TCC分布式事务后的生单链路中，什么是空回滚和悬挂问题。 其实，空回滚主要是try方法由于网络问题，一直都还没有开始执行，阻塞在了半路上，也就是出现了悬挂；此时，其他的Seata TCC分支链路如果恰好又出现了故障，就会导致在try方法还没有执行的前提下，就执行cancel方法，进行空回滚补偿，所以，一般都是因为悬挂而导致了空回滚的发生。</p><p>另外，如果所有接口的try方法都执行成功了，Seata TCC可能存在重复调用confirm方法或cancel方法的象，当然，Seata TCC的初衷，还是为了保证在try方法都执行成功的前提下，confirm方法或者cancel方法务必得要执行成功，因为，也带来了幂等性问题的风险。</p><p>最后，我们通过引入一个Map数据结构的缓存，及时记录当前try方法的执行情况，并且，当空回滚发生时，及时在数据库表中，记录空回滚的记录，这样，一旦发生了空回滚的问题，try方法在执行时也能及时感知到，避免了错误执行下去。</p><p>并且，正是因为我们添加了缓存，来记录try方法的执行状态，所以，只有当try方法执行成功后，才允许执行confirm方法或cancel方法，一旦执行完confirm或cancel方法，就会及时在缓存中清除try方法执行的记录，所以，confirm方法或cancel方法，能够保证只允许执行一次，完美解决了confirm和cancel方法重复执行的幂等性问题。</p><p>接着，订单系统在锁定库存时，就会调用库存系统的接口，此时，订单系统底层会通过dubbo，向库存系统发送一个远程的rpc网络请求，并将分布式事务的xid也传递过去。</p><h4 id="_5-5-生单链路核心执行流程的回顾" tabindex="-1"><a class="header-anchor" href="#_5-5-生单链路核心执行流程的回顾" aria-hidden="true">#</a> 5.5. 生单链路核心执行流程的回顾</h4><p>首先，我们来回顾下引入Seata TCC分布式事务后，生单核心链路的执行流程，想必大家现在已经很熟悉了：</p><p>当用户提交订单时，订单系统会先向Seata Server服务，发起一个开启新的分布式事务的请求，并获取分布式事务对应的唯一标识xid，然后，订单系统本身也会开启一个本地数据库的分支事务。</p><p>库存系统接收到订单系统的rpc请求之后，也会在本地开启一个分支事务：</p><p>可以看到，库存系统在本地开启一个分支事务之后，紧接着，就会调用数据库缓存双写的入口逻辑，从这里开始，我们就进入到了Seata TCC分布式事务的运行范围之内了。</p><figure><img src="'+x+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>可以看到，首先会依次调用写库接口和写缓存接口的try方法了，当所有接口的try方法都执行成功之后，注意，此时并不是立即依次执行各个接口的confirm方法，而是顺着生单链路的执行流程，继续执行其他分支的事务。</p><p>和之前一样，订单系统获取本地锁执行落库生单操作，然后插入相应的回滚日志，最后获取全局锁提交分支事务，并释放本地锁。</p><p>比如，接下来该轮到订单系统的Seata分支事务执行了：</p><figure><img src="'+I+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>当生单链路中的所有分支事务都执行完成之后，接下来，就会提交整体的Seata分布式事务了：</p><figure><img src="'+R+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>可以看到，Seata分布式事务提交时，才会依次的去调用库存系统对应的Seata TCC分布式事务的confirm方法，提交库存系统的分支事务，最后，完成整体分支事务的提交。</p><p>可以看到，当Seata TCC分布式事务开始执行时，首先会添加一把分布式锁，然后开始执行各个接口的try方法，当所有接口的try方法都执行成功之后，分布式锁也就释放了，然后继续执行其他Seata分支事务了。</p><h4 id="_5-6-6-seata-tcc异步提交导致数据不一致" tabindex="-1"><a class="header-anchor" href="#_5-6-6-seata-tcc异步提交导致数据不一致" aria-hidden="true">#</a> 5.6. 6.Seata TCC异步提交导致数据不一致</h4><p>我们结合生单链路来看一下：</p><p>分析到这里，想必大家已经看出一些端倪了，也就是说Seata TCC分布式事务在执行时，依次执行完各个接口的try方法之后，并不是一气呵成执行各个接口的confirm方法，而是得要等到整体的Seata分布式事务提交时，才会依次执行各个接口的confirm方法，相当于Seata TCC分布式事务的提交阶段，是异步执行的了。</p><figure><img src="'+S+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>此时，如果当前正在执行的分布式事务，如果还没来得及执行confirm方法，此时，如果其他分布式事务过来执行锁定库存操作，大家觉得try方法的执行会出问题吗？答案是不会的。</p><p>如图，可以看到在调用数据库缓存双写逻辑前，首先得要获取一把分布式锁：</p><figure><img src="'+O+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>即使前一个分布式事务，已经将分布式锁释放了，但是，如果其他多个分布式事务过来执行各个接口的try方法，分布式锁还是能够保证多个分布式事务，顺序地执行各个接口的try方法的，所以，各个接口try方法的执行，还是可以保证并发安全性的。</p><p>问题就出在各个接口的confirm方法的执行，比如在当前数据库中，某个商品的库存数据的售库存为10，锁定库存为0：</p><p>可以看到，假如当前分布式事务1先执行写库接口的try方法后，销售库存扣减1从10变为9，然后，分布式事务1释放分布式锁后，继续去执行落库生单操作，库存的锁定操作，现在还差confirm方法累加锁定库存的操作。</p><figure><img src="'+q+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>可以看到，假设此时分布式事务2，在分布式事务1初步锁定库存的基础上，获取相同的一件商品的库存数据，也就是销售库存为9，锁定库存为0，这个时候，分布式事务2获取到的库存数据中，锁定库存数据就出问题了。</p><p>这个时候，如果另一个分布式事务过来执行，就会出现问题了：</p><p>其他分布式事务过来，按理说正确获取到的库存数据，应该是上个分布式事务，已经锁定库存操作完毕的数据，而不是锁定库存逻辑执行一半的库存数据，所以，分布式事务2基于错误的数据，进行try方法以及后续的confirm方法的执行，就会出现数据不一致性的问题了。</p><figure><img src="'+D+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>为了让其他分布式事务执行try方法时，能获取到正确的库存数据，我们可以在confirm方法调用结束后，随即插入一条库存数据的操作日志：</p><h4 id="_5-7-7-引入库存操作日志来解决数据不一致问题" tabindex="-1"><a class="header-anchor" href="#_5-7-7-引入库存操作日志来解决数据不一致问题" aria-hidden="true">#</a> 5.7. 7.引入库存操作日志来解决数据不一致问题</h4><p>现在的问题，关键在于一个分布式事务还没有来的及执行confirm方法，还没有完整的将整个分布式事务提交，其他分布式事务可能就会获取到错误的库存数据，那这个问题到底该怎么解决呢？</p><p>可以看到，我们可以预先在数据库中，定义一张库存数据的操作日志表，当confirm方法执行完毕之后，插入一条操作日志。</p><figure><img src="'+F+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>然后当其他分布式事务来执行时：</p><p>可以看到，虽然分布式事务2在执行try方法时，获取到的库存数据中的销售库存数量是正确的，但是锁定库存的数量是错误的，正确的锁定库存数量应该为1。</p><figure><img src="'+Y+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>此时，当分布式事务2在执行confirm方法时，就不能基于错误的锁定库存数据0，来进行库存的累加操作，而得要先从库存操作日志表中，获取最近最新插入的一条库存记录，查询最近提交的分布式事务修改后的最新锁定库存数据。</p><p>而分布式事务1执行confirm方法后，锁定库存的数量为1才是正确的，分布式事务2查询到这条数据后，基于正确的锁定库存数据进行confirm方法的执行，最终得到锁定库存数据结果2，才是正确的数据。</p><p>相应的，分布式事务2执行完confirm操作提交时，也会插入一条相应的库存操作日志，方便其他分布式事务执行时获取，这样的话，Seata TCC异步提交导致的数据不一致问题也就解决了。</p><p>为了解决Seata TCC异步提交而导致的数据不一致问题，我们引入了库存数据的操作日志来解决这个问题，也就是在每次执行confirm方法之后，都会往库存日志表中，插入一条库存数据变更的日志。</p><h4 id="_5-8-8-总结" tabindex="-1"><a class="header-anchor" href="#_5-8-8-总结" aria-hidden="true">#</a> 5.8. 8.总结</h4><p>这一节，我们首先回顾了一下之前基于Seata和Seata TCC的生单核心链路逻辑，然后，基于生单链路的执行流程，我们发现了一个问题，也就是Seata TCC的try方法和confirm方法的执行，其实是异步的，所以，库存数据这块，在多个分布式事务同时执行时，可能就会出现数据不一致的问题。</p><p>生单链路的一系列问题，包括涉及多个数据库的数据不一致问题、锁定库存时因为全局锁而导致的并发瓶颈问题、引入Seata TCC分布式事务后的空回滚，悬挂，confirm方法和cancel方法重复执行的幂等性问题以及Seata TCC异步提交而导致的数据不一致等一系列技术问题，我们都已经悉数解决了。</p><p>虽然其他的分布式事务在执行try方法时，拿到的锁定库存数据是有问题的，但是，在具体执行confirm方法时，可以从库存日志表中，查询最近最新的一条库存操作日志，从日志中获取最新的库存数据，这样的话，锁定库存数据不一致的问题也就得到解决了。</p><p>从下一节开始，我们顺着生单链路的执行流程，继续来看下生单链路之后的订单预支付和支付回调链路中，业务流程是怎样的，并且可能会遇到哪些技术问题。</p>',171),nn={href:"https://seata.io/zh-cn/blog/seata-tcc-fence.html",target:"_blank",rel:"noopener noreferrer"};function sn(an,en){const a=l("ExternalLinkIcon");return o(),c("div",null,[H,n("p",null,[s("关于Seata的相关知识，可以先去官网了解一下。简单介绍一下，seata支持多种分布式事务，如AT模式、TCC模式、Sega模式等。"),n("a",z,[s("官网在这"),e(a)])]),G,P,W,j,X,K,n("p",null,[s("服务端版本及下载地址： "),n("a",V,[s("1.3.0"),e(a)]),s(" 源代码版本及下载地址： "),n("a",Q,[s("1.3.0"),e(a)])]),Z,n("p",null,[s("进入安装包下面的bin目录，在命令行里面直接运行 "),n("a",J,[s("seata-server.sh"),e(a)]),s(" 即可。")]),$,n("p",null,[n("a",nn,[s("TCC简介及Seata中的问题"),e(a)])])])}const on=i(B,[["render",sn],["__file","ch08-seata.html.vue"]]);export{on as default};
